---
version: 2.1
orbs:
  tfenv: suzuki-shunsuke/tfenv@dev:fa279ed83f397e1362c81358248d48d411ca1326
workflows:
  build:
    jobs:
      - tfenv/setup:
          name: setup
          checkout:
            - checkout:
                path: src
          custom_setup:
            - run:
                name: Install terraform
                # requirement bash
                # requirement curl
                # requirement: unzip
                command: |
                  export PATH=$PWD/.tfenv/bin:$PATH
                  cd src
                  tfenv install

      - tfenv/test:
          name: test foo/staging
          requires:
            - setup
          dir: src/services/foo/staging
          tfnotify_config_path: src/.tfnotify.yaml
          custom_tests:
            - tflint:
                dir: src/services/foo/staging

      - tfenv/test:
          name: test foo/production
          requires:
            - setup
          dir: src/services/foo/production
          tfnotify_config_path: src/.tfnotify.yaml
          custom_tests:
            - tflint:
                dir: src/services/foo/production

      - tfenv/test:
          name: test bar/staging
          requires:
            - setup
          dir: src/services/bar/staging
          tfnotify_config_path: src/.tfnotify.yaml
          custom_tests:
            - tflint:
                dir: src/services/bar/staging

      - tfenv/test:
          name: test bar/production
          requires:
            - setup
          dir: src/services/bar/production
          tfnotify_config_path: src/.tfnotify.yaml
          custom_tests:
            - tflint:
                dir: src/services/bar/production

      - tfenv/check_changed:
          name: Check changed states
          requires:
            - setup
            - test foo/staging
            - test foo/production
          setup_dir: .ci

      - tfenv/apply:
          name: apply
          requires:
            - setup
            - test foo/staging
            - test foo/production
            - test bar/staging
            - test bar/production
          filters:
            branches:
              only:
                - master

# Custom test with tflint
commands:
  install_tflint:
    parameters:
      dir:
        type: string
    steps:
      - run:
          name: Install tflint
          shell: /bin/bash -eu -o pipefail
          command: |
            bin_dir=$PWD/<< parameters.dir >>
            mkdir -p $bin_dir
            dirpath=$(mktemp -d)
            cd $dirpath
            curl -LO https://github.com/terraform-linters/tflint/releases/download/v0.15.1/tflint_linux_amd64.zip
            unzip tflint_linux_amd64.zip
            mv tflint $bin_dir/tflint
            chmod a+x $bin_dir/tflint
            rm -R $dirpath
  tflint:
    parameters:
      dir:
        type: string
    steps:
      - install_tflint:
          dir: .ci/bin
      - run:
          name: tflint
          shell: /bin/bash -eu -o pipefail
          command: |
            export PATH=$PWD/.ci/bin:$PATH
            cd << parameters.dir >>
            if ! tflint; then
              echo_error "tflint is failure"
              github-comment -template ":x: [Job Link]($CIRCLE_BUILD_URL) [<< parameters.dir >>] tflint is failure"
              exit 1
            fi
